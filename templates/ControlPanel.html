<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Automated Greenhouse Control Panel</title>

        <script src="https://d3js.org/d3.v6.min.js"></script>
        <style>
            body {
                background-color: #c6dfc8;  
            }

            .button {
                margin-bottom: 6px;
                padding: 10px 20px;
                font-size: 16px;
                text-align: center;
                cursor: pointer;
                outline: none;
                color: #fff;
                background-color: #04AA6D;
                border: none;
                border-radius: 10px;
                box-shadow: 0 4px #999;
            }

            .button:hover {background-color: #55BB8A}

            .button:active {
                background-color: #3e8e41;
                box-shadow: 0 4px #666;
                transform: translateY(4px);
            }

            .title {
                padding: 10px 20px;
                margin-bottom: 10px;
                border-radius: 36px;
                font-size: 24px;
                background-color: #2bae85;
                text-align: center;
            }

            .subtitle {
                padding: 3px 36px;
                margin-top: 10px;
                margin-bottom: 10px;
                border-radius: 24px;
                font-size: 16px;
                background-color: #83cbac;
            }

            .data_show {
                padding: 3px 36px;
            }
        </style>
        
    </head>
<body>

    <div class="title">
        <h1>Automated Greenhouse Control Panel</h1>
    </div>

    <div class="camera">
        <div class="subtitle">
            <h2>Camera</h2>
        </div>
        <img src='http://192.168.191.57:8000/video_feed/'>
    </div>

    <div class="data">

        <div class="subtitle">
            <h2>The latest data collected</h2>
        </div>        

        <div class="data_show">
            <p> Time: {{ data_dic.time }}</p> 

            <p> Temperature: {{ data_dic.sensor_temperature_inside }}</p>

            <p> Humidity: {{ data_dic.sensor_humidity_inside }}</p>
            <p> Temperature indoor: {{ data_dic.sensor_temperature_outside }}</p>
            <p> Humidity indoor: {{ data_dic.sensor_humidity_outside }}</p>
            <p> Light level: {{ data_dic.sensor_light}}</p>
            <p> CO2 level: {{ data_dic.sensor_CO2}}</p>
            <p> Moisture level: {{data_dic.sensor_moisture}}</p>
            
            <p> Light state: {{data_dic.light}}</p>
            <p> Water pump state: {{data_dic.waterpump}}</p>
            <p> Fan0 state: {{data_dic.fan0}}</p>
            <p> Fan1 state: {{data_dic.fan1}}</p>
            <p> Humidifier state: {{data_dic.humidifier}}</p>
            <p> Heater state: {{data_dic.heater}}</p>
        </div> 

        <div class="subtitle">
            <h2>Data visualization</h2>
        </div> 
        <Temperature></Temperature>
        <Humidity></Humidity>
        <Light></Light>
        <CO2></CO2>
        <Moisture0></Moisture0>
        <Moisture1></Moisture1>
        <Moisture2></Moisture2>
        <Moisture3></Moisture3>
    </div>




    <div class="control">
        <div class="subtitle">
            <h2>System Control</h2>
        </div>
        <form action="" method="POST">
            {% csrf_token %}
            <button class="button" type="submit" name="button_light_on" >Turn on Light</button>
        </form>
        <form action="" method="POST">
            {% csrf_token %}
            <button class="button" type="submit" name="button_light_off" >Turn off Light</button>
        </form>
        <form action="" method="POST">
            {% csrf_token %}
            <button class="button" type="submit" name="button_fan0_on" >Turn on Fan0</button>
        </form>
        <form action="" method="POST">
            {% csrf_token %}
            <button class="button" type="submit" name="button_fan0_off" >Turn off Fan0</button>
        </form>
        <form action="" method="POST">
            {% csrf_token %}
            <button class="button" type="submit" name="button_fan1_on" >Turn on Fan1</button>
        </form>
        <form action="" method="POST">
            {% csrf_token %}
            <button class="button" type="submit" name="button_fan1_off" >Turn off Fan1</button>
        </form>
        <form action="" method="POST">
            {% csrf_token %}
            <button class="button" type="submit" name="button_waterpump_on" >Turn on Water Pump for 10s</button>
        </form>
        <form action="" method="POST">
            {% csrf_token %}
            <button class="button" type="submit" name="button_humidifier_on_strong" >Increase the humidity greatly for 30min</button>
        </form>
        <form action="" method="POST">
            {% csrf_token %}
            <button class="button" type="submit" name="button_humidifier_on_weak" >Increase the humidity slightly for 30min</button>
        </form>
        <form action="" method="POST">
            {% csrf_token %}
            <button class="button" type="submit" name="button_humidifier_off" >Turn off the humidifier for 30min</button>
        </form>
        <form action="" method="POST">
            {% csrf_token %}
            <button class="button" type="submit" name="button_heater_on_strong" >Increase the temperature greatly for 30min</button>
        </form>
        <form action="" method="POST">
            {% csrf_token %}
            <button class="button" type="submit" name="button_heater_on_weak" >Increase the temperature slightly for 30min</button>
        </form>
        <form action="" method="POST">
            {% csrf_token %}
            <button class="button" type="submit" name="button_heater_off" >Turn off the heater for 30min</button>
        </form>

        {% comment %} Add buttons like the following: {% endcomment %}
        {% comment %} <form action="" method="POST">
            {% csrf_token %}
            <button class="button" type="submit" name = "button_light_on">Turn on light</button>
        </form>   {% endcomment %}

    </div>




    <script type="text/javascript">
        
        var width = 500;
        var height = 300;
        var padding = { top: 50, right: 50, bottom: 50, left: 50 };

        appendGraph("Temperature", {{visualization_data_dic.temperature_24h}});
        appendGraph("Humidity", {{visualization_data_dic.humidity_24h}})
        appendGraph("Light", {{visualization_data_dic.light_24h}})
        appendGraph("CO2", {{visualization_data_dic.CO2_24h}})
        appendGraph("Moisture0", {{visualization_data_dic.moisture_24h_0}})
        appendGraph("Moisture1", {{visualization_data_dic.moisture_24h_1}})
        appendGraph("Moisture2", {{visualization_data_dic.moisture_24h_2}})
        appendGraph("Moisture3", {{visualization_data_dic.moisture_24h_3}})


    function appendGraph(type, data){
        var svg = d3.select(type)				
        .append("svg") 
        .attr("width", width)
        .attr("height", height);


        var dataArray = data;
        var min = d3.min(dataArray, function(d) {
            return d[1];
        })
        var max = d3.max(dataArray, function(d) {
            return d[1];
        })

        var xScale = d3.scaleLinear()
                    .domain([24, 0])
                    .range([0, width - padding.left - padding.right]);
        if (type == "Temperature"){
            var yScale = d3.scaleLinear()
                        .domain([min-5, max+5])
                        .range([height - padding.top - padding.bottom, 0]);
        }else if(type == "Humidity"){
            var yScale = d3.scaleLinear()
                        .domain([min <= 10? 0: min - 10, max>=100? 100 : max])
                        .range([height - padding.top - padding.bottom, 0]);
        }else{
            var yScale = d3.scaleLinear()
                        .domain([Math.floor(min*0.75), Math.ceil(max*1.25)])
                        .range([height - padding.top - padding.bottom, 0]);
        }


        
        // graph frame work
        var xAxis = d3.axisBottom()
                    .scale(xScale);
        var yAxis = d3.axisLeft()
                    .scale(yScale);

        svg.append('g')
            .attr('class', 'axis')
            .attr('transform', 'translate(' + padding.left + ',' + (height - padding.bottom) + ')')
            .call(xAxis);
        svg.append('g')
            .attr('class', 'axis')
            .attr('transform', 'translate(' + padding.left + ',' + padding.top + ')')
            .call(yAxis);

        //line 
        var linePath = d3.line()
                        .x(function(d){ return xScale(d[0]) })
                        .y(function(d){ return yScale(d[1]) });

        svg.append('g')
            .append('path')
            .attr('class', 'line-path')
            .attr('transform', 'translate(' + padding.left + ',' + padding.top + ')')
            .attr('d', linePath(dataArray))
            .attr('fill', 'none')
            .attr('stroke-width', 3)
            .attr('stroke', '#5cb3cc');
        svg.append('g')
            .selectAll('circle')
            .data(dataArray)
            .enter()
            .append('circle')
            .attr('r', 3)
            .attr('transform', function(d){
                return 'translate(' + (xScale(d[0]) + padding.left) + ',' + (yScale(d[1]) + padding.top) + ')'
            })
            .attr('fill', '#5cb3cc');

        //axis title
        svg.append("text")
            .attr("transform", "translate(" + (width/2) + "," + (height - padding.bottom / 3) + ")")
            .style("text-anchor", "middle")
            .text("Number of hours ago");
        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("x", (-height / 2))
            .attr("y", 0)
            .attr("dy", "1em")
            .style("text-anchor" , "middle")
            .text(type);

        //graph title
        svg.append("text")
            .attr("x", (width/2))
            .attr("y", (padding.left / 2 ))
            .attr("text-anchor", "middle")
            .style("font-size", "20px")
            .text(type + " in the near 24h (record per hour)");
        }


    </script>


</body>
</html>